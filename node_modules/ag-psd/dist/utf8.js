"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function charLengthInBytes(code) {
    if ((code & 0xffffff80) === 0) {
        return 1;
    }
    else if ((code & 0xfffff800) === 0) {
        return 2;
    }
    else if ((code & 0xffff0000) === 0) {
        return 3;
    }
    else {
        return 4;
    }
}
function stringLengthInBytes(value) {
    var result = 0;
    for (var i = 0; i < value.length; i++) {
        var code = value.charCodeAt(i);
        // high surrogate
        if (code >= 0xd800 && code <= 0xdbff) {
            if ((i + 1) < value.length) {
                var extra = value.charCodeAt(i + 1);
                // low surrogate
                if ((extra & 0xfc00) === 0xdc00) {
                    i++;
                    result += charLengthInBytes(((code & 0x3ff) << 10) + (extra & 0x3ff) + 0x10000);
                }
            }
        }
        else {
            result += charLengthInBytes(code);
        }
    }
    return result;
}
exports.stringLengthInBytes = stringLengthInBytes;
function writeCharacter(buffer, offset, code) {
    var length = charLengthInBytes(code);
    switch (length) {
        case 1:
            buffer[offset] = code;
            break;
        case 2:
            buffer[offset] = ((code >> 6) & 0x1f) | 0xc0;
            buffer[offset + 1] = (code & 0x3f) | 0x80;
            break;
        case 3:
            buffer[offset] = ((code >> 12) & 0x0f) | 0xe0;
            buffer[offset + 1] = ((code >> 6) & 0x3f) | 0x80;
            buffer[offset + 2] = (code & 0x3f) | 0x80;
            break;
        default:
            buffer[offset] = ((code >> 18) & 0x07) | 0xf0;
            buffer[offset + 1] = ((code >> 12) & 0x3f) | 0x80;
            buffer[offset + 2] = ((code >> 6) & 0x3f) | 0x80;
            buffer[offset + 3] = (code & 0x3f) | 0x80;
            break;
    }
    return length;
}
function encodeStringTo(buffer, offset, value) {
    for (var i = 0; i < value.length; i++) {
        var code = value.charCodeAt(i);
        // high surrogate
        if (code >= 0xd800 && code <= 0xdbff) {
            if ((i + 1) < value.length) {
                var extra = value.charCodeAt(i + 1);
                // low surrogate
                if ((extra & 0xfc00) === 0xdc00) {
                    i++;
                    var fullCode = ((code & 0x3ff) << 10) + (extra & 0x3ff) + 0x10000;
                    offset += writeCharacter(buffer, offset, fullCode);
                }
            }
        }
        else {
            offset += writeCharacter(buffer, offset, code);
        }
    }
    return offset;
}
exports.encodeStringTo = encodeStringTo;
function encodeString(value) {
    var buffer = new Uint8Array(stringLengthInBytes(value));
    encodeStringTo(buffer, 0, value);
    return buffer;
}
exports.encodeString = encodeString;
function continuationByte(buffer, index) {
    if (index >= buffer.length) {
        throw Error('Invalid byte index');
    }
    var continuationByte = buffer[index];
    if ((continuationByte & 0xC0) === 0x80) {
        return continuationByte & 0x3F;
    }
    else {
        throw Error('Invalid continuation byte');
    }
}
function decodeString(value) {
    var result = '';
    for (var i = 0; i < value.length;) {
        var byte1 = value[i++];
        var code = void 0;
        if ((byte1 & 0x80) === 0) {
            code = byte1;
        }
        else if ((byte1 & 0xe0) === 0xc0) {
            var byte2 = continuationByte(value, i++);
            code = ((byte1 & 0x1f) << 6) | byte2;
            if (code < 0x80) {
                throw Error('Invalid continuation byte');
            }
        }
        else if ((byte1 & 0xf0) === 0xe0) {
            var byte2 = continuationByte(value, i++);
            var byte3 = continuationByte(value, i++);
            code = ((byte1 & 0x0f) << 12) | (byte2 << 6) | byte3;
            if (code < 0x0800) {
                throw Error('Invalid continuation byte');
            }
            if (code >= 0xd800 && code <= 0xdfff) {
                throw Error("Lone surrogate U+" + code.toString(16).toUpperCase() + " is not a scalar value");
            }
        }
        else if ((byte1 & 0xf8) === 0xf0) {
            var byte2 = continuationByte(value, i++);
            var byte3 = continuationByte(value, i++);
            var byte4 = continuationByte(value, i++);
            code = ((byte1 & 0x0f) << 0x12) | (byte2 << 0x0c) | (byte3 << 0x06) | byte4;
            if (code < 0x010000 || code > 0x10ffff) {
                throw Error('Invalid continuation byte');
            }
        }
        else {
            throw Error('Invalid UTF-8 detected');
        }
        if (code > 0xffff) {
            code -= 0x10000;
            result += String.fromCharCode(code >>> 10 & 0x3ff | 0xd800);
            code = 0xdc00 | code & 0x3ff;
        }
        result += String.fromCharCode(code);
    }
    return result;
}
exports.decodeString = decodeString;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0ZjgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxTQUFTLGlCQUFpQixDQUFDLElBQVk7SUFDdEMsSUFBSSxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDOUIsT0FBTyxDQUFDLENBQUM7S0FDVDtTQUFNLElBQUksQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ3JDLE9BQU8sQ0FBQyxDQUFDO0tBQ1Q7U0FBTSxJQUFJLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUNyQyxPQUFPLENBQUMsQ0FBQztLQUNUO1NBQU07UUFDTixPQUFPLENBQUMsQ0FBQztLQUNUO0FBQ0YsQ0FBQztBQUVELFNBQWdCLG1CQUFtQixDQUFDLEtBQWE7SUFDaEQsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBRWYsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDdEMsSUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVqQyxpQkFBaUI7UUFDakIsSUFBSSxJQUFJLElBQUksTUFBTSxJQUFJLElBQUksSUFBSSxNQUFNLEVBQUU7WUFDckMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFO2dCQUMzQixJQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFFdEMsZ0JBQWdCO2dCQUNoQixJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLE1BQU0sRUFBRTtvQkFDaEMsQ0FBQyxFQUFFLENBQUM7b0JBQ0osTUFBTSxJQUFJLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUM7aUJBQ2hGO2FBQ0Q7U0FDRDthQUFNO1lBQ04sTUFBTSxJQUFJLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2xDO0tBQ0Q7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNmLENBQUM7QUF2QkQsa0RBdUJDO0FBRUQsU0FBUyxjQUFjLENBQUMsTUFBMkIsRUFBRSxNQUFjLEVBQUUsSUFBWTtJQUNoRixJQUFNLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV2QyxRQUFRLE1BQU0sRUFBRTtRQUNmLEtBQUssQ0FBQztZQUNMLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDdEIsTUFBTTtRQUNQLEtBQUssQ0FBQztZQUNMLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztZQUM3QyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztZQUMxQyxNQUFNO1FBQ1AsS0FBSyxDQUFDO1lBQ0wsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQzlDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDakQsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDMUMsTUFBTTtRQUNQO1lBQ0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQzlDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDbEQsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztZQUNqRCxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztZQUMxQyxNQUFNO0tBQ1A7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNmLENBQUM7QUFFRCxTQUFnQixjQUFjLENBQUMsTUFBMkIsRUFBRSxNQUFjLEVBQUUsS0FBYTtJQUN4RixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUN0QyxJQUFNLElBQUksR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWpDLGlCQUFpQjtRQUNqQixJQUFJLElBQUksSUFBSSxNQUFNLElBQUksSUFBSSxJQUFJLE1BQU0sRUFBRTtZQUNyQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUU7Z0JBQzNCLElBQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUV0QyxnQkFBZ0I7Z0JBQ2hCLElBQUksQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLEtBQUssTUFBTSxFQUFFO29CQUNoQyxDQUFDLEVBQUUsQ0FBQztvQkFDSixJQUFNLFFBQVEsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLE9BQU8sQ0FBQztvQkFDcEUsTUFBTSxJQUFJLGNBQWMsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2lCQUNuRDthQUNEO1NBQ0Q7YUFBTTtZQUNOLE1BQU0sSUFBSSxjQUFjLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztTQUMvQztLQUNEO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDZixDQUFDO0FBdEJELHdDQXNCQztBQUVELFNBQWdCLFlBQVksQ0FBQyxLQUFhO0lBQ3pDLElBQU0sTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDMUQsY0FBYyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDakMsT0FBTyxNQUFNLENBQUM7QUFDZixDQUFDO0FBSkQsb0NBSUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLE1BQWtCLEVBQUUsS0FBYTtJQUMxRCxJQUFJLEtBQUssSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO1FBQzNCLE1BQU0sS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7S0FDbEM7SUFFRCxJQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUV2QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3ZDLE9BQU8sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0tBQy9CO1NBQU07UUFDTixNQUFNLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0tBQ3pDO0FBQ0YsQ0FBQztBQUVELFNBQWdCLFlBQVksQ0FBQyxLQUFpQjtJQUM3QyxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7SUFFaEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEdBQUc7UUFDbEMsSUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDekIsSUFBSSxJQUFJLFNBQVEsQ0FBQztRQUVqQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN6QixJQUFJLEdBQUcsS0FBSyxDQUFDO1NBQ2I7YUFBTSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNuQyxJQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7WUFFckMsSUFBSSxJQUFJLEdBQUcsSUFBSSxFQUFFO2dCQUNoQixNQUFNLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO2FBQ3pDO1NBQ0Q7YUFBTSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNuQyxJQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQyxJQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7WUFFckQsSUFBSSxJQUFJLEdBQUcsTUFBTSxFQUFFO2dCQUNsQixNQUFNLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO2FBQ3pDO1lBRUQsSUFBSSxJQUFJLElBQUksTUFBTSxJQUFJLElBQUksSUFBSSxNQUFNLEVBQUU7Z0JBQ3JDLE1BQU0sS0FBSyxDQUFDLHNCQUFvQixJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSwyQkFBd0IsQ0FBQyxDQUFDO2FBQ3pGO1NBQ0Q7YUFBTSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNuQyxJQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQyxJQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQyxJQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7WUFFNUUsSUFBSSxJQUFJLEdBQUcsUUFBUSxJQUFJLElBQUksR0FBRyxRQUFRLEVBQUU7Z0JBQ3ZDLE1BQU0sS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7YUFDekM7U0FDRDthQUFNO1lBQ04sTUFBTSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztTQUN0QztRQUVELElBQUksSUFBSSxHQUFHLE1BQU0sRUFBRTtZQUNsQixJQUFJLElBQUksT0FBTyxDQUFDO1lBQ2hCLE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxFQUFFLEdBQUcsS0FBSyxHQUFHLE1BQU0sQ0FBQyxDQUFDO1lBQzVELElBQUksR0FBRyxNQUFNLEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQztTQUM3QjtRQUVELE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3BDO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDZixDQUFDO0FBbkRELG9DQW1EQyIsImZpbGUiOiJ1dGY4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiZnVuY3Rpb24gY2hhckxlbmd0aEluQnl0ZXMoY29kZTogbnVtYmVyKTogbnVtYmVyIHtcclxuXHRpZiAoKGNvZGUgJiAweGZmZmZmZjgwKSA9PT0gMCkge1xyXG5cdFx0cmV0dXJuIDE7XHJcblx0fSBlbHNlIGlmICgoY29kZSAmIDB4ZmZmZmY4MDApID09PSAwKSB7XHJcblx0XHRyZXR1cm4gMjtcclxuXHR9IGVsc2UgaWYgKChjb2RlICYgMHhmZmZmMDAwMCkgPT09IDApIHtcclxuXHRcdHJldHVybiAzO1xyXG5cdH0gZWxzZSB7XHJcblx0XHRyZXR1cm4gNDtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdMZW5ndGhJbkJ5dGVzKHZhbHVlOiBzdHJpbmcpOiBudW1iZXIge1xyXG5cdGxldCByZXN1bHQgPSAwO1xyXG5cclxuXHRmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRjb25zdCBjb2RlID0gdmFsdWUuY2hhckNvZGVBdChpKTtcclxuXHJcblx0XHQvLyBoaWdoIHN1cnJvZ2F0ZVxyXG5cdFx0aWYgKGNvZGUgPj0gMHhkODAwICYmIGNvZGUgPD0gMHhkYmZmKSB7XHJcblx0XHRcdGlmICgoaSArIDEpIDwgdmFsdWUubGVuZ3RoKSB7XHJcblx0XHRcdFx0Y29uc3QgZXh0cmEgPSB2YWx1ZS5jaGFyQ29kZUF0KGkgKyAxKTtcclxuXHJcblx0XHRcdFx0Ly8gbG93IHN1cnJvZ2F0ZVxyXG5cdFx0XHRcdGlmICgoZXh0cmEgJiAweGZjMDApID09PSAweGRjMDApIHtcclxuXHRcdFx0XHRcdGkrKztcclxuXHRcdFx0XHRcdHJlc3VsdCArPSBjaGFyTGVuZ3RoSW5CeXRlcygoKGNvZGUgJiAweDNmZikgPDwgMTApICsgKGV4dHJhICYgMHgzZmYpICsgMHgxMDAwMCk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRyZXN1bHQgKz0gY2hhckxlbmd0aEluQnl0ZXMoY29kZSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5mdW5jdGlvbiB3cml0ZUNoYXJhY3RlcihidWZmZXI6IFVpbnQ4QXJyYXkgfCBCdWZmZXIsIG9mZnNldDogbnVtYmVyLCBjb2RlOiBudW1iZXIpOiBudW1iZXIge1xyXG5cdGNvbnN0IGxlbmd0aCA9IGNoYXJMZW5ndGhJbkJ5dGVzKGNvZGUpO1xyXG5cclxuXHRzd2l0Y2ggKGxlbmd0aCkge1xyXG5cdFx0Y2FzZSAxOlxyXG5cdFx0XHRidWZmZXJbb2Zmc2V0XSA9IGNvZGU7XHJcblx0XHRcdGJyZWFrO1xyXG5cdFx0Y2FzZSAyOlxyXG5cdFx0XHRidWZmZXJbb2Zmc2V0XSA9ICgoY29kZSA+PiA2KSAmIDB4MWYpIHwgMHhjMDtcclxuXHRcdFx0YnVmZmVyW29mZnNldCArIDFdID0gKGNvZGUgJiAweDNmKSB8IDB4ODA7XHJcblx0XHRcdGJyZWFrO1xyXG5cdFx0Y2FzZSAzOlxyXG5cdFx0XHRidWZmZXJbb2Zmc2V0XSA9ICgoY29kZSA+PiAxMikgJiAweDBmKSB8IDB4ZTA7XHJcblx0XHRcdGJ1ZmZlcltvZmZzZXQgKyAxXSA9ICgoY29kZSA+PiA2KSAmIDB4M2YpIHwgMHg4MDtcclxuXHRcdFx0YnVmZmVyW29mZnNldCArIDJdID0gKGNvZGUgJiAweDNmKSB8IDB4ODA7XHJcblx0XHRcdGJyZWFrO1xyXG5cdFx0ZGVmYXVsdDpcclxuXHRcdFx0YnVmZmVyW29mZnNldF0gPSAoKGNvZGUgPj4gMTgpICYgMHgwNykgfCAweGYwO1xyXG5cdFx0XHRidWZmZXJbb2Zmc2V0ICsgMV0gPSAoKGNvZGUgPj4gMTIpICYgMHgzZikgfCAweDgwO1xyXG5cdFx0XHRidWZmZXJbb2Zmc2V0ICsgMl0gPSAoKGNvZGUgPj4gNikgJiAweDNmKSB8IDB4ODA7XHJcblx0XHRcdGJ1ZmZlcltvZmZzZXQgKyAzXSA9IChjb2RlICYgMHgzZikgfCAweDgwO1xyXG5cdFx0XHRicmVhaztcclxuXHR9XHJcblxyXG5cdHJldHVybiBsZW5ndGg7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBlbmNvZGVTdHJpbmdUbyhidWZmZXI6IFVpbnQ4QXJyYXkgfCBCdWZmZXIsIG9mZnNldDogbnVtYmVyLCB2YWx1ZTogc3RyaW5nKTogbnVtYmVyIHtcclxuXHRmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRjb25zdCBjb2RlID0gdmFsdWUuY2hhckNvZGVBdChpKTtcclxuXHJcblx0XHQvLyBoaWdoIHN1cnJvZ2F0ZVxyXG5cdFx0aWYgKGNvZGUgPj0gMHhkODAwICYmIGNvZGUgPD0gMHhkYmZmKSB7XHJcblx0XHRcdGlmICgoaSArIDEpIDwgdmFsdWUubGVuZ3RoKSB7XHJcblx0XHRcdFx0Y29uc3QgZXh0cmEgPSB2YWx1ZS5jaGFyQ29kZUF0KGkgKyAxKTtcclxuXHJcblx0XHRcdFx0Ly8gbG93IHN1cnJvZ2F0ZVxyXG5cdFx0XHRcdGlmICgoZXh0cmEgJiAweGZjMDApID09PSAweGRjMDApIHtcclxuXHRcdFx0XHRcdGkrKztcclxuXHRcdFx0XHRcdGNvbnN0IGZ1bGxDb2RlID0gKChjb2RlICYgMHgzZmYpIDw8IDEwKSArIChleHRyYSAmIDB4M2ZmKSArIDB4MTAwMDA7XHJcblx0XHRcdFx0XHRvZmZzZXQgKz0gd3JpdGVDaGFyYWN0ZXIoYnVmZmVyLCBvZmZzZXQsIGZ1bGxDb2RlKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH1cclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdG9mZnNldCArPSB3cml0ZUNoYXJhY3RlcihidWZmZXIsIG9mZnNldCwgY29kZSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gb2Zmc2V0O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZW5jb2RlU3RyaW5nKHZhbHVlOiBzdHJpbmcpOiBVaW50OEFycmF5IHtcclxuXHRjb25zdCBidWZmZXIgPSBuZXcgVWludDhBcnJheShzdHJpbmdMZW5ndGhJbkJ5dGVzKHZhbHVlKSk7XHJcblx0ZW5jb2RlU3RyaW5nVG8oYnVmZmVyLCAwLCB2YWx1ZSk7XHJcblx0cmV0dXJuIGJ1ZmZlcjtcclxufVxyXG5cclxuZnVuY3Rpb24gY29udGludWF0aW9uQnl0ZShidWZmZXI6IFVpbnQ4QXJyYXksIGluZGV4OiBudW1iZXIpOiBudW1iZXIge1xyXG5cdGlmIChpbmRleCA+PSBidWZmZXIubGVuZ3RoKSB7XHJcblx0XHR0aHJvdyBFcnJvcignSW52YWxpZCBieXRlIGluZGV4Jyk7XHJcblx0fVxyXG5cclxuXHRjb25zdCBjb250aW51YXRpb25CeXRlID0gYnVmZmVyW2luZGV4XTtcclxuXHJcblx0aWYgKChjb250aW51YXRpb25CeXRlICYgMHhDMCkgPT09IDB4ODApIHtcclxuXHRcdHJldHVybiBjb250aW51YXRpb25CeXRlICYgMHgzRjtcclxuXHR9IGVsc2Uge1xyXG5cdFx0dGhyb3cgRXJyb3IoJ0ludmFsaWQgY29udGludWF0aW9uIGJ5dGUnKTtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVTdHJpbmcodmFsdWU6IFVpbnQ4QXJyYXkpOiBzdHJpbmcge1xyXG5cdGxldCByZXN1bHQgPSAnJztcclxuXHJcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7KSB7XHJcblx0XHRjb25zdCBieXRlMSA9IHZhbHVlW2krK107XHJcblx0XHRsZXQgY29kZTogbnVtYmVyO1xyXG5cclxuXHRcdGlmICgoYnl0ZTEgJiAweDgwKSA9PT0gMCkge1xyXG5cdFx0XHRjb2RlID0gYnl0ZTE7XHJcblx0XHR9IGVsc2UgaWYgKChieXRlMSAmIDB4ZTApID09PSAweGMwKSB7XHJcblx0XHRcdGNvbnN0IGJ5dGUyID0gY29udGludWF0aW9uQnl0ZSh2YWx1ZSwgaSsrKTtcclxuXHRcdFx0Y29kZSA9ICgoYnl0ZTEgJiAweDFmKSA8PCA2KSB8IGJ5dGUyO1xyXG5cclxuXHRcdFx0aWYgKGNvZGUgPCAweDgwKSB7XHJcblx0XHRcdFx0dGhyb3cgRXJyb3IoJ0ludmFsaWQgY29udGludWF0aW9uIGJ5dGUnKTtcclxuXHRcdFx0fVxyXG5cdFx0fSBlbHNlIGlmICgoYnl0ZTEgJiAweGYwKSA9PT0gMHhlMCkge1xyXG5cdFx0XHRjb25zdCBieXRlMiA9IGNvbnRpbnVhdGlvbkJ5dGUodmFsdWUsIGkrKyk7XHJcblx0XHRcdGNvbnN0IGJ5dGUzID0gY29udGludWF0aW9uQnl0ZSh2YWx1ZSwgaSsrKTtcclxuXHRcdFx0Y29kZSA9ICgoYnl0ZTEgJiAweDBmKSA8PCAxMikgfCAoYnl0ZTIgPDwgNikgfCBieXRlMztcclxuXHJcblx0XHRcdGlmIChjb2RlIDwgMHgwODAwKSB7XHJcblx0XHRcdFx0dGhyb3cgRXJyb3IoJ0ludmFsaWQgY29udGludWF0aW9uIGJ5dGUnKTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0aWYgKGNvZGUgPj0gMHhkODAwICYmIGNvZGUgPD0gMHhkZmZmKSB7XHJcblx0XHRcdFx0dGhyb3cgRXJyb3IoYExvbmUgc3Vycm9nYXRlIFUrJHtjb2RlLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpfSBpcyBub3QgYSBzY2FsYXIgdmFsdWVgKTtcclxuXHRcdFx0fVxyXG5cdFx0fSBlbHNlIGlmICgoYnl0ZTEgJiAweGY4KSA9PT0gMHhmMCkge1xyXG5cdFx0XHRjb25zdCBieXRlMiA9IGNvbnRpbnVhdGlvbkJ5dGUodmFsdWUsIGkrKyk7XHJcblx0XHRcdGNvbnN0IGJ5dGUzID0gY29udGludWF0aW9uQnl0ZSh2YWx1ZSwgaSsrKTtcclxuXHRcdFx0Y29uc3QgYnl0ZTQgPSBjb250aW51YXRpb25CeXRlKHZhbHVlLCBpKyspO1xyXG5cdFx0XHRjb2RlID0gKChieXRlMSAmIDB4MGYpIDw8IDB4MTIpIHwgKGJ5dGUyIDw8IDB4MGMpIHwgKGJ5dGUzIDw8IDB4MDYpIHwgYnl0ZTQ7XHJcblxyXG5cdFx0XHRpZiAoY29kZSA8IDB4MDEwMDAwIHx8IGNvZGUgPiAweDEwZmZmZikge1xyXG5cdFx0XHRcdHRocm93IEVycm9yKCdJbnZhbGlkIGNvbnRpbnVhdGlvbiBieXRlJyk7XHJcblx0XHRcdH1cclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHRocm93IEVycm9yKCdJbnZhbGlkIFVURi04IGRldGVjdGVkJyk7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKGNvZGUgPiAweGZmZmYpIHtcclxuXHRcdFx0Y29kZSAtPSAweDEwMDAwO1xyXG5cdFx0XHRyZXN1bHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlID4+PiAxMCAmIDB4M2ZmIHwgMHhkODAwKTtcclxuXHRcdFx0Y29kZSA9IDB4ZGMwMCB8IGNvZGUgJiAweDNmZjtcclxuXHRcdH1cclxuXHJcblx0XHRyZXN1bHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlKTtcclxuXHR9XHJcblxyXG5cdHJldHVybiByZXN1bHQ7XHJcbn1cclxuIl0sInNvdXJjZVJvb3QiOiJEOlxcUHJvamVjdHNcXGdpdGh1YlxcYWctcHNkXFxzcmMifQ==
