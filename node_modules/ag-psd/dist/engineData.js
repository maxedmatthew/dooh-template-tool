"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function parseEngineData(data) {
    var openBracket = '('.charCodeAt(0);
    var closeBracket = ')'.charCodeAt(0);
    var text = '';
    for (var i = 0; i < data.length; i++) {
        if (i < data.length - 3 && data[i] === openBracket && data[i + 1] === 0xfe && data[i + 2] === 0xff) {
            text += String.fromCharCode(data[i]);
            for (i += 3; i < (data.length - 1) && data[i] !== closeBracket; i += 2) {
                text += String.fromCharCode((data[i] << 8) | data[i + 1]);
            }
            i--;
        }
        else {
            text += String.fromCharCode(data[i]);
        }
    }
    var nodeStack = [];
    var propertyStack = [];
    var node = undefined;
    var property;
    function updateNode(propertyValue, nodeValue) {
        if (Array.isArray(nodeValue)) {
            nodeValue.push(node);
        }
        else if (nodeValue) {
            nodeValue[propertyValue] = node;
        }
    }
    var index = 0;
    function isWhitespace(char) {
        return char === ' ' || char === '\n' || char === '\r' || char === '\t';
    }
    function skipWhitespace() {
        while (index < text.length && isWhitespace(text.charAt(index))) {
            index++;
        }
    }
    function getToken() {
        var char = text.charAt(index);
        if (char === '<' && text.charAt(index + 1) === '<') {
            index += 2;
            return '<<';
        }
        else if (char === '>' && text.charAt(index + 1) === '>') {
            index += 2;
            return '>>';
        }
        else if (char === '/' || char === '(' || char === '[' || char === ']') {
            index += 1;
            return char;
        }
        else if (char === 't' && text.substr(index, 4) === 'true') {
            index += 4;
            return 'true';
        }
        else if (char === 'f' && text.substr(index, 5) === 'false') {
            index += 5;
            return 'false';
        }
        else if (/[0-9.-]/.test(char)) {
            return '0';
        }
        else {
            index += 1;
            return "invalid token \"" + char + "\" at " + index + " around \"" + text.substring(index - 10, index + 10) + "\"";
        }
    }
    function getName() {
        var start = index;
        while (index < text.length && !isWhitespace(text.charAt(index))) {
            index++;
        }
        return text.substring(start, index);
    }
    function getText() {
        var start = index;
        while (index < text.length && text.charAt(index) !== ')') {
            if (text.charAt(index) === '\\') {
                index++;
            }
            index++;
        }
        index++;
        return text.substring(start, index - 1);
    }
    function getNumber() {
        var start = index;
        while (index < text.length && /[0-9.-]/.test(text.charAt(index))) {
            index++;
        }
        return parseFloat(text.substring(start, index));
    }
    function addValue(value) {
        if (Array.isArray(node)) {
            node.push(value);
        }
        else if (node) {
            node[property] = value;
        }
    }
    skipWhitespace();
    while (index < text.length) {
        var token = getToken();
        switch (token) {
            case '<<': {
                nodeStack.push(node);
                propertyStack.push(property);
                node = {};
                property = undefined;
                break;
            }
            case '>>': {
                var nodeValue = nodeStack.pop();
                var propertyValue = propertyStack.pop();
                if (nodeValue) {
                    updateNode(propertyValue, nodeValue);
                    node = nodeValue;
                }
                break;
            }
            case '/': {
                property = getName();
                break;
            }
            case '(': {
                var text_1 = getText();
                addValue(text_1);
                break;
            }
            case '[': {
                nodeStack.push(node);
                propertyStack.push(property);
                node = [];
                property = undefined;
                break;
            }
            case ']': {
                var nodeValue = nodeStack.pop();
                var propertyValue = propertyStack.pop();
                updateNode(propertyValue, nodeValue);
                node = nodeValue;
                break;
            }
            case '0': {
                addValue(getNumber());
                break;
            }
            case 'true':
            case 'false': {
                addValue(token === 'true');
                break;
            }
            default:
                console.log('# unhandled token', token);
        }
        skipWhitespace();
    }
    // console.log(JSON.stringify(node, null, 2)); // .substr(0, 1000));
    // require('fs').writeFileSync('engineData.json', JSON.stringify(node, null, 2), 'utf8');
    return node;
}
exports.parseEngineData = parseEngineData;
function serializeEngineData(data) {
    var indent = '';
    var lines = ['', ''];
    function serializeProperty(key, value) {
        var index = lines.length;
        lines.push(indent + "/" + key);
        var serialized = serializeValue(value);
        if (serialized) {
            lines[index] += ' ' + serialized;
        }
    }
    function serializeNumber(value) {
        if ((value | 0) === value) {
            return value.toString();
        }
        else {
            return value.toFixed(3).replace(/(\d)0+$/g, '$1');
        }
    }
    function serializeValue(value) {
        if (typeof value === 'number') {
            return serializeNumber(value);
        }
        else if (typeof value === 'boolean') {
            return value ? 'true' : 'false';
        }
        else if (typeof value === 'string') {
            var encoded = '\u00fe\u00ff';
            for (var i = 0; i < value.length; i++) {
                var charCode = value.charCodeAt(i);
                encoded += "" + String.fromCharCode(charCode >> 8) + String.fromCharCode(charCode & 0xff);
            }
            return "(" + encoded + ")";
        }
        else if (Array.isArray(value)) {
            if (value.every(function (x) { return typeof x === 'number'; })) {
                return "[ " + value.map(serializeNumber).join(' ') + " ]";
            }
            else {
                var temp = indent;
                indent = indent + '\t';
                for (var i = 0; i < value.length; i++) {
                    var serialized = serializeValue(value[i]);
                    if (serialized) {
                        lines.push("" + indent + serialized);
                    }
                }
                indent = temp;
                lines.push(indent + "]");
                return '[';
            }
        }
        else if (typeof value === 'object') {
            lines.push(indent + "<<");
            var temp = indent;
            indent = indent + '\t';
            for (var _i = 0, _a = Object.keys(value); _i < _a.length; _i++) {
                var key = _a[_i];
                serializeProperty(key, value[key]);
            }
            indent = temp;
            lines.push(indent + ">>");
        }
        return undefined;
    }
    serializeValue(data);
    var buffer = new Uint8Array(lines.reduce(function (sum, line) { return sum + line.length + 1; }, 0) - 1);
    var offset = 0;
    for (var _i = 0, lines_1 = lines; _i < lines_1.length; _i++) {
        var line = lines_1[_i];
        for (var i = 0; i < line.length; i++, offset++) {
            buffer[offset] = line.charCodeAt(i);
        }
        buffer[offset] = '\n'.charCodeAt(0);
        offset++;
    }
    // console.log('serialized:\n', lines.join('\n'));
    return buffer;
}
exports.serializeEngineData = serializeEngineData;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QztJQUVELGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVyQixJQUFNLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQUMsR0FBRyxFQUFFLElBQUksSUFBSyxPQUFBLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBckIsQ0FBcUIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN6RixJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFFZixLQUFtQixVQUFLLEVBQUwsZUFBSyxFQUFMLG1CQUFLLEVBQUwsSUFBSyxFQUFFO1FBQXJCLElBQU0sSUFBSSxjQUFBO1FBQ2QsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUcsTUFBTSxFQUFFLEVBQUU7WUFDaEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDcEM7UUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQyxNQUFNLEVBQUUsQ0FBQztLQUNUO0lBRUQsa0RBQWtEO0lBRWxELE9BQU8sTUFBTSxDQUFDO0FBQ2YsQ0FBQztBQXhGRCxrREF3RkMiLCJmaWxlIjoiZW5naW5lRGF0YS5qcyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBmdW5jdGlvbiBwYXJzZUVuZ2luZURhdGEoZGF0YTogbnVtYmVyW10gfCBVaW50OEFycmF5KSB7XHJcblx0Y29uc3Qgb3BlbkJyYWNrZXQgPSAnKCcuY2hhckNvZGVBdCgwKTtcclxuXHRjb25zdCBjbG9zZUJyYWNrZXQgPSAnKScuY2hhckNvZGVBdCgwKTtcclxuXHRsZXQgdGV4dCA9ICcnO1xyXG5cclxuXHRmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcclxuXHRcdGlmIChpIDwgZGF0YS5sZW5ndGggLSAzICYmIGRhdGFbaV0gPT09IG9wZW5CcmFja2V0ICYmIGRhdGFbaSArIDFdID09PSAweGZlICYmIGRhdGFbaSArIDJdID09PSAweGZmKSB7XHJcblx0XHRcdHRleHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShkYXRhW2ldKTtcclxuXHJcblx0XHRcdGZvciAoaSArPSAzOyBpIDwgKGRhdGEubGVuZ3RoIC0gMSkgJiYgZGF0YVtpXSAhPT0gY2xvc2VCcmFja2V0OyBpICs9IDIpIHtcclxuXHRcdFx0XHR0ZXh0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKGRhdGFbaV0gPDwgOCkgfCBkYXRhW2kgKyAxXSk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGktLTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHRleHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShkYXRhW2ldKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGNvbnN0IG5vZGVTdGFjazogYW55W10gPSBbXTtcclxuXHRjb25zdCBwcm9wZXJ0eVN0YWNrOiAoc3RyaW5nIHwgdW5kZWZpbmVkKVtdID0gW107XHJcblxyXG5cdGxldCBub2RlOiBhbnkgPSB1bmRlZmluZWQ7XHJcblx0bGV0IHByb3BlcnR5OiBzdHJpbmcgfCB1bmRlZmluZWQ7XHJcblxyXG5cdGZ1bmN0aW9uIHVwZGF0ZU5vZGUocHJvcGVydHlWYWx1ZTogc3RyaW5nLCBub2RlVmFsdWU6IGFueSkge1xyXG5cdFx0aWYgKEFycmF5LmlzQXJyYXkobm9kZVZhbHVlKSkge1xyXG5cdFx0XHRub2RlVmFsdWUucHVzaChub2RlKTtcclxuXHRcdH0gZWxzZSBpZiAobm9kZVZhbHVlKSB7XHJcblx0XHRcdG5vZGVWYWx1ZVtwcm9wZXJ0eVZhbHVlIV0gPSBub2RlO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0bGV0IGluZGV4ID0gMDtcclxuXHJcblx0ZnVuY3Rpb24gaXNXaGl0ZXNwYWNlKGNoYXI6IHN0cmluZykge1xyXG5cdFx0cmV0dXJuIGNoYXIgPT09ICcgJyB8fCBjaGFyID09PSAnXFxuJyB8fCBjaGFyID09PSAnXFxyJyB8fCBjaGFyID09PSAnXFx0JztcclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIHNraXBXaGl0ZXNwYWNlKCkge1xyXG5cdFx0d2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGggJiYgaXNXaGl0ZXNwYWNlKHRleHQuY2hhckF0KGluZGV4KSkpIHtcclxuXHRcdFx0aW5kZXgrKztcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIGdldFRva2VuKCkge1xyXG5cdFx0Y29uc3QgY2hhciA9IHRleHQuY2hhckF0KGluZGV4KTtcclxuXHJcblx0XHRpZiAoY2hhciA9PT0gJzwnICYmIHRleHQuY2hhckF0KGluZGV4ICsgMSkgPT09ICc8Jykge1xyXG5cdFx0XHRpbmRleCArPSAyO1xyXG5cdFx0XHRyZXR1cm4gJzw8JztcclxuXHRcdH0gZWxzZSBpZiAoY2hhciA9PT0gJz4nICYmIHRleHQuY2hhckF0KGluZGV4ICsgMSkgPT09ICc+Jykge1xyXG5cdFx0XHRpbmRleCArPSAyO1xyXG5cdFx0XHRyZXR1cm4gJz4+JztcclxuXHRcdH0gZWxzZSBpZiAoY2hhciA9PT0gJy8nIHx8IGNoYXIgPT09ICcoJyB8fCBjaGFyID09PSAnWycgfHwgY2hhciA9PT0gJ10nKSB7XHJcblx0XHRcdGluZGV4ICs9IDE7XHJcblx0XHRcdHJldHVybiBjaGFyO1xyXG5cdFx0fSBlbHNlIGlmIChjaGFyID09PSAndCcgJiYgdGV4dC5zdWJzdHIoaW5kZXgsIDQpID09PSAndHJ1ZScpIHtcclxuXHRcdFx0aW5kZXggKz0gNDtcclxuXHRcdFx0cmV0dXJuICd0cnVlJztcclxuXHRcdH0gZWxzZSBpZiAoY2hhciA9PT0gJ2YnICYmIHRleHQuc3Vic3RyKGluZGV4LCA1KSA9PT0gJ2ZhbHNlJykge1xyXG5cdFx0XHRpbmRleCArPSA1O1xyXG5cdFx0XHRyZXR1cm4gJ2ZhbHNlJztcclxuXHRcdH0gZWxzZSBpZiAoL1swLTkuLV0vLnRlc3QoY2hhcikpIHtcclxuXHRcdFx0cmV0dXJuICcwJztcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGluZGV4ICs9IDE7XHJcblx0XHRcdHJldHVybiBgaW52YWxpZCB0b2tlbiBcIiR7Y2hhcn1cIiBhdCAke2luZGV4fSBhcm91bmQgXCIke3RleHQuc3Vic3RyaW5nKGluZGV4IC0gMTAsIGluZGV4ICsgMTApfVwiYDtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIGdldE5hbWUoKSB7XHJcblx0XHRjb25zdCBzdGFydCA9IGluZGV4O1xyXG5cclxuXHRcdHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoICYmICFpc1doaXRlc3BhY2UodGV4dC5jaGFyQXQoaW5kZXgpKSkge1xyXG5cdFx0XHRpbmRleCsrO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiB0ZXh0LnN1YnN0cmluZyhzdGFydCwgaW5kZXgpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gZ2V0VGV4dCgpIHtcclxuXHRcdGNvbnN0IHN0YXJ0ID0gaW5kZXg7XHJcblxyXG5cdFx0d2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGggJiYgdGV4dC5jaGFyQXQoaW5kZXgpICE9PSAnKScpIHtcclxuXHRcdFx0aWYgKHRleHQuY2hhckF0KGluZGV4KSA9PT0gJ1xcXFwnKSB7XHJcblx0XHRcdFx0aW5kZXgrKztcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0aW5kZXgrKztcclxuXHRcdH1cclxuXHJcblx0XHRpbmRleCsrO1xyXG5cclxuXHRcdHJldHVybiB0ZXh0LnN1YnN0cmluZyhzdGFydCwgaW5kZXggLSAxKTtcclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIGdldE51bWJlcigpIHtcclxuXHRcdGNvbnN0IHN0YXJ0ID0gaW5kZXg7XHJcblxyXG5cdFx0d2hpbGUgKGluZGV4IDwgdGV4dC5sZW5ndGggJiYgL1swLTkuLV0vLnRlc3QodGV4dC5jaGFyQXQoaW5kZXgpKSkge1xyXG5cdFx0XHRpbmRleCsrO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiBwYXJzZUZsb2F0KHRleHQuc3Vic3RyaW5nKHN0YXJ0LCBpbmRleCkpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gYWRkVmFsdWUodmFsdWU6IGFueSkge1xyXG5cdFx0aWYgKEFycmF5LmlzQXJyYXkobm9kZSkpIHtcclxuXHRcdFx0bm9kZS5wdXNoKHZhbHVlKTtcclxuXHRcdH0gZWxzZSBpZiAobm9kZSkge1xyXG5cdFx0XHRub2RlW3Byb3BlcnR5IV0gPSB2YWx1ZTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHNraXBXaGl0ZXNwYWNlKCk7XHJcblxyXG5cdHdoaWxlIChpbmRleCA8IHRleHQubGVuZ3RoKSB7XHJcblx0XHRjb25zdCB0b2tlbiA9IGdldFRva2VuKCk7XHJcblxyXG5cdFx0c3dpdGNoICh0b2tlbikge1xyXG5cdFx0XHRjYXNlICc8PCc6IHtcclxuXHRcdFx0XHRub2RlU3RhY2sucHVzaChub2RlKTtcclxuXHRcdFx0XHRwcm9wZXJ0eVN0YWNrLnB1c2gocHJvcGVydHkpO1xyXG5cdFx0XHRcdG5vZGUgPSB7fTtcclxuXHRcdFx0XHRwcm9wZXJ0eSA9IHVuZGVmaW5lZDtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0fVxyXG5cdFx0XHRjYXNlICc+Pic6IHtcclxuXHRcdFx0XHRjb25zdCBub2RlVmFsdWUgPSBub2RlU3RhY2sucG9wKCk7XHJcblx0XHRcdFx0Y29uc3QgcHJvcGVydHlWYWx1ZSA9IHByb3BlcnR5U3RhY2sucG9wKCk7XHJcblxyXG5cdFx0XHRcdGlmIChub2RlVmFsdWUpIHtcclxuXHRcdFx0XHRcdHVwZGF0ZU5vZGUocHJvcGVydHlWYWx1ZSEsIG5vZGVWYWx1ZSk7XHJcblx0XHRcdFx0XHRub2RlID0gbm9kZVZhbHVlO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0fVxyXG5cdFx0XHRjYXNlICcvJzoge1xyXG5cdFx0XHRcdHByb3BlcnR5ID0gZ2V0TmFtZSgpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHR9XHJcblx0XHRcdGNhc2UgJygnOiB7XHJcblx0XHRcdFx0Y29uc3QgdGV4dCA9IGdldFRleHQoKTtcclxuXHRcdFx0XHRhZGRWYWx1ZSh0ZXh0KTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0fVxyXG5cdFx0XHRjYXNlICdbJzoge1xyXG5cdFx0XHRcdG5vZGVTdGFjay5wdXNoKG5vZGUpO1xyXG5cdFx0XHRcdHByb3BlcnR5U3RhY2sucHVzaChwcm9wZXJ0eSk7XHJcblx0XHRcdFx0bm9kZSA9IFtdO1xyXG5cdFx0XHRcdHByb3BlcnR5ID0gdW5kZWZpbmVkO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHR9XHJcblx0XHRcdGNhc2UgJ10nOiB7XHJcblx0XHRcdFx0Y29uc3Qgbm9kZVZhbHVlID0gbm9kZVN0YWNrLnBvcCgpO1xyXG5cdFx0XHRcdGNvbnN0IHByb3BlcnR5VmFsdWUgPSBwcm9wZXJ0eVN0YWNrLnBvcCgpO1xyXG5cdFx0XHRcdHVwZGF0ZU5vZGUocHJvcGVydHlWYWx1ZSEsIG5vZGVWYWx1ZSk7XHJcblx0XHRcdFx0bm9kZSA9IG5vZGVWYWx1ZTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0fVxyXG5cdFx0XHRjYXNlICcwJzoge1xyXG5cdFx0XHRcdGFkZFZhbHVlKGdldE51bWJlcigpKTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0fVxyXG5cdFx0XHRjYXNlICd0cnVlJzpcclxuXHRcdFx0Y2FzZSAnZmFsc2UnOiB7XHJcblx0XHRcdFx0YWRkVmFsdWUodG9rZW4gPT09ICd0cnVlJyk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdH1cclxuXHRcdFx0ZGVmYXVsdDpcclxuXHRcdFx0XHRjb25zb2xlLmxvZygnIyB1bmhhbmRsZWQgdG9rZW4nLCB0b2tlbik7XHJcblx0XHR9XHJcblxyXG5cdFx0c2tpcFdoaXRlc3BhY2UoKTtcclxuXHR9XHJcblxyXG5cdC8vIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG5vZGUsIG51bGwsIDIpKTsgLy8gLnN1YnN0cigwLCAxMDAwKSk7XHJcblx0Ly8gcmVxdWlyZSgnZnMnKS53cml0ZUZpbGVTeW5jKCdlbmdpbmVEYXRhLmpzb24nLCBKU09OLnN0cmluZ2lmeShub2RlLCBudWxsLCAyKSwgJ3V0ZjgnKTtcclxuXHJcblx0cmV0dXJuIG5vZGU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemVFbmdpbmVEYXRhKGRhdGE6IGFueSkge1xyXG5cdGxldCBpbmRlbnQgPSAnJztcclxuXHRsZXQgbGluZXM6IHN0cmluZ1tdID0gWycnLCAnJ107XHJcblxyXG5cdGZ1bmN0aW9uIHNlcmlhbGl6ZVByb3BlcnR5KGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcblx0XHRjb25zdCBpbmRleCA9IGxpbmVzLmxlbmd0aDtcclxuXHRcdGxpbmVzLnB1c2goYCR7aW5kZW50fS8ke2tleX1gKTtcclxuXHRcdGNvbnN0IHNlcmlhbGl6ZWQgPSBzZXJpYWxpemVWYWx1ZSh2YWx1ZSk7XHJcblxyXG5cdFx0aWYgKHNlcmlhbGl6ZWQpIHtcclxuXHRcdFx0bGluZXNbaW5kZXhdICs9ICcgJyArIHNlcmlhbGl6ZWQ7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBzZXJpYWxpemVOdW1iZXIodmFsdWU6IG51bWJlcikge1xyXG5cdFx0aWYgKCh2YWx1ZSB8IDApID09PSB2YWx1ZSkge1xyXG5cdFx0XHRyZXR1cm4gdmFsdWUudG9TdHJpbmcoKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHJldHVybiB2YWx1ZS50b0ZpeGVkKDMpLnJlcGxhY2UoLyhcXGQpMCskL2csICckMScpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gc2VyaWFsaXplVmFsdWUodmFsdWU6IGFueSkge1xyXG5cdFx0aWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHtcclxuXHRcdFx0cmV0dXJuIHNlcmlhbGl6ZU51bWJlcih2YWx1ZSk7XHJcblx0XHR9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XHJcblx0XHRcdHJldHVybiB2YWx1ZSA/ICd0cnVlJyA6ICdmYWxzZSc7XHJcblx0XHR9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcclxuXHRcdFx0bGV0IGVuY29kZWQgPSAnXFx1MDBmZVxcdTAwZmYnO1xyXG5cclxuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRcdGNvbnN0IGNoYXJDb2RlID0gdmFsdWUuY2hhckNvZGVBdChpKTtcclxuXHRcdFx0XHRlbmNvZGVkICs9IGAke1N0cmluZy5mcm9tQ2hhckNvZGUoY2hhckNvZGUgPj4gOCl9JHtTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlICYgMHhmZil9YDtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0cmV0dXJuIGAoJHtlbmNvZGVkfSlgO1xyXG5cdFx0fSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG5cdFx0XHRpZiAodmFsdWUuZXZlcnkoeCA9PiB0eXBlb2YgeCA9PT0gJ251bWJlcicpKSB7XHJcblx0XHRcdFx0cmV0dXJuIGBbICR7dmFsdWUubWFwKHNlcmlhbGl6ZU51bWJlcikuam9pbignICcpfSBdYDtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRjb25zdCB0ZW1wID0gaW5kZW50O1xyXG5cdFx0XHRcdGluZGVudCA9IGluZGVudCArICdcXHQnO1xyXG5cclxuXHRcdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0XHRjb25zdCBzZXJpYWxpemVkID0gc2VyaWFsaXplVmFsdWUodmFsdWVbaV0pO1xyXG5cclxuXHRcdFx0XHRcdGlmIChzZXJpYWxpemVkKSB7XHJcblx0XHRcdFx0XHRcdGxpbmVzLnB1c2goYCR7aW5kZW50fSR7c2VyaWFsaXplZH1gKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdGluZGVudCA9IHRlbXA7XHJcblx0XHRcdFx0bGluZXMucHVzaChgJHtpbmRlbnR9XWApO1xyXG5cdFx0XHRcdHJldHVybiAnWyc7XHJcblx0XHRcdH1cclxuXHRcdH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xyXG5cdFx0XHRsaW5lcy5wdXNoKGAke2luZGVudH08PGApO1xyXG5cdFx0XHRjb25zdCB0ZW1wID0gaW5kZW50O1xyXG5cdFx0XHRpbmRlbnQgPSBpbmRlbnQgKyAnXFx0JztcclxuXHJcblx0XHRcdGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHZhbHVlKSkge1xyXG5cdFx0XHRcdHNlcmlhbGl6ZVByb3BlcnR5KGtleSwgdmFsdWVba2V5XSk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGluZGVudCA9IHRlbXA7XHJcblx0XHRcdGxpbmVzLnB1c2goYCR7aW5kZW50fT4+YCk7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcclxuXHR9XHJcblxyXG5cdHNlcmlhbGl6ZVZhbHVlKGRhdGEpO1xyXG5cclxuXHRjb25zdCBidWZmZXIgPSBuZXcgVWludDhBcnJheShsaW5lcy5yZWR1Y2UoKHN1bSwgbGluZSkgPT4gc3VtICsgbGluZS5sZW5ndGggKyAxLCAwKSAtIDEpO1xyXG5cdGxldCBvZmZzZXQgPSAwO1xyXG5cclxuXHRmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcclxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGluZS5sZW5ndGg7IGkrKyAsIG9mZnNldCsrKSB7XHJcblx0XHRcdGJ1ZmZlcltvZmZzZXRdID0gbGluZS5jaGFyQ29kZUF0KGkpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGJ1ZmZlcltvZmZzZXRdID0gJ1xcbicuY2hhckNvZGVBdCgwKTtcclxuXHRcdG9mZnNldCsrO1xyXG5cdH1cclxuXHJcblx0Ly8gY29uc29sZS5sb2coJ3NlcmlhbGl6ZWQ6XFxuJywgbGluZXMuam9pbignXFxuJykpO1xyXG5cclxuXHRyZXR1cm4gYnVmZmVyO1xyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiRDpcXFByb2plY3RzXFxnaXRodWJcXGFnLXBzZFxcc3JjIn0=
